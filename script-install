#!/bin/bash

set -e

# === CONFIG ===
WINE_VERSION="1.3.11"
SRC_DIR="$HOME/src"
PREFIX="/opt/wine-$WINE_VERSION"
NUM_CORES=$(nproc)

# === PREPARE SYSTEM ===
echo "==> Updating and installing dependencies..."

sudo apt-get update
sudo apt-get install -y \
  build-essential flex bison libx11-dev libfreetype6-dev libxcursor-dev \
  libxrandr-dev libxi-dev libxinerama-dev libxext-dev libxrender-dev \
  libgl1-mesa-dev libglu1-mesa-dev libfontconfig1-dev libjpeg-dev \
  libpng-dev libcups2-dev libdbus-1-dev libgsm1-dev libldap2-dev \
  libopenal-dev libv4l-dev libxcomposite-dev libxml2-dev libxslt1-dev \
  libasound2-dev libgphoto2-dev libgnutls28-dev libxinerama-dev \
  libxvidcore-dev libmpg123-dev libxdamage-dev libfaudio-dev \
  libncurses-dev zlib1g-dev xorg openbox wget xinit

# === CREATE SRC DIR ===
mkdir -p "$SRC_DIR"
cd "$SRC_DIR"

# === DOWNLOAD WINE ===
if [ ! -f "wine-$WINE_VERSION.tar.bz2" ]; then
  echo "==> Downloading Wine $WINE_VERSION source..."
  wget -O "wine-$WINE_VERSION.tar.bz2" \
    "https://source.winehq.org/patches/data/$WINE_VERSION/wine-$WINE_VERSION.tar.bz2"
fi

# === EXTRACT ===
if [ ! -d "wine-$WINE_VERSION" ]; then
  echo "==> Extracting Wine..."
  tar -xjf "wine-$WINE_VERSION.tar.bz2"
fi

# === BUILD ===
cd "wine-$WINE_VERSION"
echo "==> Configuring Wine..."
./configure --prefix="$PREFIX"

echo "==> Building Wine with $NUM_CORES cores..."
make -j"$NUM_CORES"

echo "==> Installing Wine to $PREFIX..."
make install

# === SET UP .xinitrc ===
echo "==> Creating .xinitrc to launch openbox and winefile..."
cat <<EOF > "$HOME/.xinitrc"
#!/bin/sh
openbox-session &
sleep 2
export WINEPREFIX=\$HOME/.wine
export PATH="$PREFIX/bin:\$PATH"
winefile
EOF
chmod +x "$HOME/.xinitrc"

echo "==> DONE. You can start X with:"
echo "       startx"
echo ""
echo "Wine $WINE_VERSION is installed at: $PREFIX"
echo "Winefile will launch when X starts."
